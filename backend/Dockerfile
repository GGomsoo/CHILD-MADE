# 1단계: 애플리케이션 빌드
FROM gradle:8.5-jdk17 as builder
WORKDIR /app

# Gradle 빌드에 필요한 파일들 복사
COPY build.gradle settings.gradle /app/
COPY src /app/src

# 빌드 수행
RUN gradle build -x test --parallel --continue

FROM openjdk:17
# VOLUME /tmp
EXPOSE 8081

# ARG DB_URL
# ARG DB_USERNAME
# ARG DB_PASSWORD
# ARG S3_ACCESSKEY
# ARG S3_SECRETKEY
# ARG S3_NAME
# ARG GOOGLE_CLIENT_ID
# ARG GOOGLE_CLIENT_SECRET
# ARG KAKAO_CLIENT_ID
# ARG KAKAO_CLIENT_SECRET
# ARG JWT_SECRET
# ARG EC2_PUBLIC_IP
# ARG REDIS_PW
# ARG OPENVIDU_URL
# ARG OPENVIDU_SECRET

# ENV DB_URL=$DB_URL
# ENV DB_USERNAME=$DB_USERNAME
# ENV DB_PASSWORD=$DB_PASSWORD
# ENV S3_ACCESSKEY=$S3_ACCESSKEY
# ENV S3_SECRETKEY=$S3_SECRETKEY
# ENV S3_NAME=$S3_NAME
# ENV GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
# ENV GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
# ENV KAKAO_CLIENT_ID=$KAKAO_CLIENT_ID
# ENV KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET
# ENV JWT_SECRET=$JWT_SECRET
# ENV EC2_PUBLIC_IP=$EC2_PUBLIC_IP
# ENV REDIS_PW=$REDIS_PW
# ENV OPENVIDU_URL=$OPENVIDU_URL
# ENV OPENVIDU_SECRET=$OPENVIDU_SECRET

# 이미지 생성 시 파일 복사
COPY --from=builder /app/build/libs/*.jar /app/app.jar
CMD ["java", "-jar", "/app/app.jar"]